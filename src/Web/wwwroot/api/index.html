<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>My API Docs</title>
    <link rel="stylesheet" href="https://unpkg.com/swagger-ui-dist/swagger-ui.css">
    <style>
        body {
            margin: 0;
        }

        #swagger-ui {
            height: 100vh;
        }

        #login-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 10;
        }
    </style>
</head>
<body>

    <button id="login-btn">Login with Google</button>
    <div id="swagger-ui"></div>

    <script src="https://unpkg.com/swagger-ui-dist/swagger-ui-bundle.js"></script>
    <script>
        function parseHashParams(hash) {
            const params = {};
            const regex = /([^&=]+)=([^&]*)/g;
            let m;
            while ((m = regex.exec(hash)) !== null) {
                params[decodeURIComponent(m[1])] = decodeURIComponent(m[2]);
            }
            return params;
        }

        function saveTokensFromUrl() {
            const hash = window.location.hash.substring(1);
            const params = parseHashParams(hash);
            debugger;
            if (params['access_token']) {
                localStorage.setItem('access_token', params['access_token']);
                localStorage.setItem('id_token', params['id_token']);
                // Remove hash from URL
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }

        function getAccessToken() {
            debugger;
            return localStorage.getItem('id_token');
        }

        document.getElementById('login-btn').addEventListener('click', () => {
            debugger;
            const clientId = '44473283156-7op213480o9p3jagklfremnp8qunugm3.apps.googleusercontent.com';
            const redirectUri = 'https://localhost:5002/api/oauth2-redirect.html';
            const scope = 'openid email profile';
            const responseType = 'code';
            const nonce = 'random_nonce_value'; // Optional: generate securely
            const authUrl =
                `https://accounts.google.com/o/oauth2/v2/auth` +
                `?client_id=${clientId}` +
                `&redirect_uri=${encodeURIComponent(redirectUri)}` +
                `&response_type=${responseType}` +
                `&scope=${encodeURIComponent(scope)}` +
                `&nonce=${nonce}` +
                `&prompt=select_account`;

            window.location.href = authUrl;
        });

        window.onload = () => {
            saveTokensFromUrl();

            const ui = SwaggerUIBundle({
                url: "/api/specification.json", // <- Match NSwag path
                dom_id: '#swagger-ui',
                requestInterceptor: (req) => {
                    debugger;
                    const token = getAccessToken();
                    if (token) {
                        req.headers['Authorization'] = `Bearer ${token}`;
                    }
                    return req;
                },
                presets: [SwaggerUIBundle.presets.apis],
                layout: "BaseLayout",
            });
            ui.initOAuth({
                clientId: "44473283156-7op213480o9p3jagklfremnp8qunugm3.apps.googleusercontent.com",
                usePkceWithAuthorizationCodeGrant: true,
                scopes: "openid profile email",
                redirectUri: "https://localhost:5002/api/oauth2-redirect.html"
            });
        };
    </script>
</body>
</html>
